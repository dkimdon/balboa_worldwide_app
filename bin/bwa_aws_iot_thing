#!/usr/bin/env ruby

require 'aws-sdk-iotdataplane'
require 'bwa/client'
require 'bwa/discovery'
require 'json'

SAVED_SHADOW = '/home/dkimdon/balboa_worldwide_app/shadow.json'
reported = {}
desired = {}

def get_reported(spa)
  # Get current state from spa
  message = spa.poll
  reported = {}
  reported['temperature'] = message.current_temperature.to_i

  if message.temperature_range == :low
    reported['temperature_range'] = "low"
  elsif message.temperature_range == :high
    reported['temperature_range'] = "high"
  end

  if message.heating_mode == :ready
    reported['heating_mode'] = "ready"
  elsif message.heating_mode == :rest
    reported['heating_mode'] = "rest"
  end

  reported['set_temperature'] = message.set_temperature.to_i

  return reported
end

def spa_control(spa, aws, thing_name)

  # Read saved shadow
  previous_shadow = JSON.parse(File.read(SAVED_SHADOW))
  # TODO - what to do if there is no previous shadow?    

  previous_desired = previous_shadow['state']['desired']
  previous_reported = previous_shadow['state']['reported']

  # Get current shadow from AWS
  # TODO - catch exception if there is no shadow
  resp = aws.get_thing_shadow({
    thing_name: thing_name
  })
  current_shadow = JSON.parse(resp['payload'].string)

  if current_shadow == nil
    r = aws.update_thing_shadow({
      thing_name: thing_name,
      payload: previous_shadow.to_json
    })
    return
  end

  current_desired = { "set_temperature" => current_shadow['state']['desired']['set_temperature'],
                      "temperature_range" => current_shadow['state']['desired']['temperature_range'],
                      "heating_mode" => current_shadow['state']['desired']['heating_mode']}

  current_reported = get_reported(spa)

  new_shadow = { }

  if (current_reported['set_temperature'] != previous_reported['set_temperature']) ||
     (current_reported['temperature_range'] != previous_reported['temperature_range']) ||
     (current_reported['heating_mode'] != previous_reported['heating_mode'])
    # Someone changed the spa state, possibly by the front panel, update desired state
    # to match
    new_desired = { "set_temperature" => current_reported['set_temperature'],
                     "temperature_range" => current_reported['temperature_range'],
                     "heating_mode" => current_reported['heating_mode']}
    new_shadow = { "state" => { "reported" => current_reported, "desired" => new_desired}}
  else

    if current_desired['temperature_range'] != current_reported['temperature_range']
      puts "change temperature range"
      spa.toggle_temperature_range()
    end

    if current_desired['set_temperature'] != current_reported['set_temperature']
      puts "change set_temperature"
      spa.set_temperature(current_desired['set_temperature'].to_i)
    end

    if current_desired['heating_mode'] != current_reported['heating_mode']
      puts "change heating mode"
      spa.toggle_heating_mode()
    end

    # Now read from spa
    current_reported = get_reported(spa)

    new_desired = { "set_temperature" => current_reported['set_temperature'],
                     "temperature_range" => current_reported['temperature_range'],
                     "heating_mode" => current_reported['heating_mode']}

    new_shadow = { "state" => { "reported" => current_reported, "desired" => new_desired}}
  end

  puts new_shadow
  r = aws.update_thing_shadow({
    thing_name: thing_name,
    payload: new_shadow.to_json
  })

  File.open(SAVED_SHADOW,"w") do |f|
    f.write(new_shadow.to_json)
  end
end

spas = BWA::Discovery.discover
if spas.empty?
  $stderr.puts "Could not find spa!"
  exit 1
end
spa_ip = spas.first.first

spa = BWA::Client.new(spa_ip)

aws = Aws::IoTDataPlane::Client.new(
  region: 'us-west-2',
  endpoint: 'https://a3fqpqsy13jcnc.iot.us-west-2.amazonaws.com'
)

thing_name = "HotTub"

spa_control(spa, aws, thing_name)

